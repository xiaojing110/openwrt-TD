name: 构建 LEDE / ImmortalWrt 固件

on:
  workflow_dispatch:
    inputs:
      source:
        description: '选择编译源码'
        required: true
        default: 'lede'
        type: choice
        options:
          - lede
          - immortalwrt

      lan_ip:
        description: '后台 LAN IP'
        required: false
        default: '10.0.0.1'

      config_url:
        description: '自定义 .config 地址'
        required: false
        default: ''

      diy_url:
        description: '远程 diy.sh'
        required: false
        default: ''

      enable_mtk_patch:
        description: '启用 MTK MT7987 头文件补丁'
        required: false
        default: 'false'
        type: choice
        options: [ 'false', 'true' ]

      mtk_kernel_mode:
        description: 'MTK 内核编译模式'
        required: false
        default: 'dual'
        type: choice
        options:
          - dual
          - only_6_12
          - only_6_6

env:
  TZ: Asia/Shanghai
  LAN_IP: ${{ github.event.inputs.lan_ip }}
  SOURCE: ${{ github.event.inputs.source }}
  CONFIG_URL: ${{ github.event.inputs.config_url }}
  DIY_URL: ${{ github.event.inputs.diy_url }}
  ENABLE_MTK_PATCH: ${{ github.event.inputs.enable_mtk_patch }}
  MTK_KERNEL_MODE: ${{ github.event.inputs.mtk_kernel_mode }}

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: 设置时间
        run: sudo timedatectl set-timezone "$TZ"

      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget zip

      - name: 克隆源码
        run: |
          if [ "$SOURCE" = "immortalwrt" ]; then
            git clone https://github.com/immortalwrt/immortalwrt.git lede
          else
            git clone https://github.com/coolsnowwolf/lede.git lede
          fi

      - name: 执行 diy.sh
        working-directory: lede
        run: |
          if [ -n "$DIY_URL" ]; then
            wget -O /tmp/diy.sh "$DIY_URL"
            bash /tmp/diy.sh
          elif [ -f ../diy.sh ]; then
            bash ../diy.sh
          fi

      - name: 更新 feeds
        working-directory: lede
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      - name: 加载 .config
        run: |
          if [ -n "$CONFIG_URL" ]; then
            wget -O lede/.config "$CONFIG_URL"
          else
            cp .config lede/.config || true
          fi

      - name: defconfig
        working-directory: lede
        run: make defconfig

      - name: 判断是否 MTK
        id: detect
        working-directory: lede
        run: |
          if grep -q CONFIG_TARGET_mediatek=y .config; then
            echo "IS_MTK=true" >> $GITHUB_ENV
          else
            echo "IS_MTK=false" >> $GITHUB_ENV
          fi

      # ========= MTK 编译函数 =========
      - name: MTK 编译
        if: env.IS_MTK == 'true'
        working-directory: lede
        run: |
          build_kernel() {
            ver=$1
            sed -i "s/^KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=$ver/" \
              target/linux/mediatek/Makefile
            make defconfig
            make download -j$(nproc)
            make -j$(nproc)
            mkdir -p ../output/kernel-$ver
            cp -r bin/* ../output/kernel-$ver/
          }

          case "$MTK_KERNEL_MODE" in
            dual)
              build_kernel 6.6
              make dirclean
              ./scripts/feeds update -a
              ./scripts/feeds install -a -f
              build_kernel 6.12
              ;;
            only_6_12)
              build_kernel 6.12
              ;;
            only_6_6)
              build_kernel 6.6
              ;;
          esac

      - name: 普通平台编译
        if: env.IS_MTK == 'false'
        working-directory: lede
        run: |
          make download -j$(nproc)
          make -j$(nproc)
          mkdir -p ../output/normal
          cp -r bin/* ../output/normal/

      - name: 打包 packages
        run: |
          cd output
          for d in */packages; do
            zip -r "$(basename $(dirname $d))-packages.zip" "$d"
          done

      - name: 生成 Release 说明
        run: |
          DATE=$(date '+%y%m%d')
          NAME=$(echo "$SOURCE" | tr a-z A-Z)
          echo "$NAME-Thatdream-$DATE" > release_name.txt

          cat > release_note.txt << EOF
固件目标: $FIRMWARE_TYPE
编译时间: $(date '+%Y-%m-%d %H:%M:%S')
后台地址: http://$LAN_IP
用户名: root
密码: password
已预装 PassWall + MosDNS + Argon 主题
源代码来源: $SOURCE
配置来源: ${CONFIG_URL:-仓库/默认}
EOF

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: ${{ steps.name.outputs.name }}
          body_path: release_note.txt
          files: output/**/*
