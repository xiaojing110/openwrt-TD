name: 构建 LEDE / ImmortalWRT 固件

on:
  workflow_dispatch:
    inputs:
      source:
        description: '选择源码（lede 或 immortalwrt）'
        required: true
        default: 'lede'
        type: choice
        options:
          - lede
          - immortalwrt

      lan_ip:
        description: '自定义后台 LAN IP（例如 192.168.5.1 或 10.0.0.1）'
        required: false
        default: '10.0.0.1'

      config_url:
        description: '自定义 .config 地址（填写则优先使用此配置文件）'
        required: false
        default: ''

      diy_url:
        description: '自定义 diy.sh 地址（留空则默认使用本仓库 diy.sh）'
        required: false
        default: ''

      enable_mtk_patch:
        description: '启用 MTK MT7987 头文件补丁下载（适用于 MTK 机型）'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

      mtk_build_mode:
        description: 'MTK 编译模式（仅 mediatek 生效）'
        required: false
        default: 'all'
        type: choice
        options:
          - '6.6'
          - '6.12'
          - 'all'

env:
  SOURCE: ${{ github.event.inputs.source }}
  LAN_IP: ${{ github.event.inputs.lan_ip || '10.0.0.1' }}
  CONFIG_URL: ${{ github.event.inputs.config_url }}
  DIY_URL: ${{ github.event.inputs.diy_url }}
  ENABLE_MTK_PATCH: ${{ github.event.inputs.enable_mtk_patch }}
  MTK_BUILD_MODE: ${{ github.event.inputs.mtk_build_mode }}

  # 默认备用 config（当输入URL为空且仓库没找到本地config时使用）
  REMOTE_CONFIG_URL: "https://raw.githubusercontent.com/xiaojing110/openwrt-TD/main/X86/.config"

  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码（main）
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: 显示仓库文件结构（调试）
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "当前目录："
          pwd
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "根目录文件："
          ls -la
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "查找 config / diy.sh 文件："
          find . -maxdepth 3 -type f \( -name ".config" -o -name "*.config" -o -name "diy.sh" \) || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 设置时区
        run: |
          sudo timedatectl set-timezone "${TZ}"

      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip \
            p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: 克隆源码（lede / immortalwrt）
        run: |
          if [ "${SOURCE}" = "immortalwrt" ]; then
            echo "✔ 克隆 ImmortalWRT 源码..."
            git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git lede
          else
            echo "✔ 克隆 LEDE 源码..."
            git clone --depth=1 https://github.com/coolsnowwolf/lede.git lede
          fi

      # ────────────────────────────────────────────────
      # diy.sh 远程调用（默认本仓库）
      # feeds 更新之前执行
      # ────────────────────────────────────────────────
      - name: 执行 diy.sh（feeds 前执行）
        working-directory: ./lede
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "开始执行 diy.sh（feeds 前执行）"
          echo "DIY_URL: ${DIY_URL}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ -n "${DIY_URL}" ]; then
            echo "✔ 使用远程 diy.sh..."
            wget -O diy.sh "${DIY_URL}" || {
              echo "❌ diy.sh 下载失败：${DIY_URL}"
              exit 1
            }
          else
            if [ -f "../diy.sh" ]; then
              echo "✔ 使用本仓库 diy.sh..."
              cp -fv ../diy.sh diy.sh
            else
              echo "⚠️ 未找到 diy.sh，自动生成默认 diy.sh..."
              cat > diy.sh << 'EOF'
echo "修改 feeds.conf.default..."
echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default
echo "src-git small https://github.com/kenzok8/small" >> feeds.conf.default
EOF
            fi
          fi

          chmod +x diy.sh

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "diy.sh 内容："
          cat diy.sh
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          ./diy.sh || {
            echo "❌ diy.sh 执行失败"
            exit 1
          }

      - name: 修改 feeds.conf.default（可选）
        working-directory: ./lede
        run: |
          sed -i '/^src-git luci/c\src-git luci https://github.com/coolsnowwolf/luci.git;openwrt-25.12' feeds.conf.default || true
          sed -i 's/^#src-git qmodem/src-git qmodem/' feeds.conf.default || true
          echo "src-git mosdns https://github.com/sbwml/luci-app-mosdns.git" >> feeds.conf.default || true

      - name: 更新并安装 feeds（重要：放在 .config 之前）
        working-directory: ./lede
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      # ────────────────────────────────────────────────
      # 加载 .config：输入URL > 仓库本地 > 默认REMOTE
      # ────────────────────────────────────────────────
      - name: 加载 .config（优先自定义 URL）
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "开始加载 .config 配置文件..."
          echo "CONFIG_URL: ${CONFIG_URL}"
          echo "默认备用 REMOTE_CONFIG_URL: ${{ env.REMOTE_CONFIG_URL }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          FOUND_CONFIG=""

          # 1. 输入 config_url 优先
          if [ -n "${CONFIG_URL}" ]; then
            echo "✔ 使用输入的 config_url 下载..."
            wget -O lede/.config "${CONFIG_URL}" || {
              echo "❌ config_url 下载失败：${CONFIG_URL}"
              exit 1
            }
            FOUND_CONFIG="custom_url"
          else
            # 2. 仓库本地优先
            if [ -f ".config" ]; then
              FOUND_CONFIG=".config"
            elif [ -f "X86/.config" ]; then
              FOUND_CONFIG="X86/.config"
            elif [ -f "X86/X86.config" ]; then
              FOUND_CONFIG="X86/X86.config"
            fi

            if [ -n "$FOUND_CONFIG" ]; then
              echo "✔ 已找到仓库配置文件：$FOUND_CONFIG"
              cp -fv "$FOUND_CONFIG" lede/.config
            else
              echo "⚠️ 仓库内未找到任何 .config，准备使用默认 REMOTE_CONFIG_URL..."
              wget -O lede/.config "${{ env.REMOTE_CONFIG_URL }}" || {
                echo "❌ 默认 raw 下载失败，请检查 URL"
                exit 1
              }
              FOUND_CONFIG="default_remote"
            fi
          fi

          if [ ! -s "lede/.config" ]; then
            echo "❌ .config 文件为空，停止运行"
            exit 1
          fi

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "最终 lede/.config 文件信息："
          ls -la lede/.config
          echo "前 30 行预览："
          head -n 30 lede/.config || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 执行 defconfig 并显示摘要
        working-directory: ./lede
        run: |
          make defconfig
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "最终 .config 关键配置预览："
          grep -E "CONFIG_TARGET_|CONFIG_PACKAGE_luci|CONFIG_PACKAGE_passwall|CONFIG_PACKAGE_mosdns|CONFIG_PACKAGE_luci-theme-argon" .config | sort | uniq || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 判断是否为 MTK mediatek 目标
        working-directory: ./lede
        run: |
          if grep -q "CONFIG_TARGET_mediatek=y" .config; then
            echo "IS_MTK=true" >> $GITHUB_ENV
            echo "✔ 检测到 MTK mediatek 目标"
          else
            echo "IS_MTK=false" >> $GITHUB_ENV
            echo "⚠️ 非 MTK mediatek 目标"
          fi

      # ────────────────────────────────────────────────
      # MTK补丁下载：写入所有 files-* 内核目录（6.6/6.12 全部写入）
      # ────────────────────────────────────────────────
      - name: 下载 MTK MT7987 补丁（所有内核 files-*）
        if: env.IS_MTK == 'true'
        working-directory: ./lede
        run: |
          if [ "${ENABLE_MTK_PATCH}" != "true" ]; then
            echo "⚠️ 未启用 MTK 补丁下载，跳过"
            exit 0
          fi

          echo "✔ 启用 MTK MT7987 补丁下载..."

          BASE_DIR="target/linux/mediatek"
          if [ ! -d "$BASE_DIR" ]; then
            echo "❌ mediatek 目录不存在：$BASE_DIR"
            exit 1
          fi

          FILES_LIST=$(ls -d ${BASE_DIR}/files-* 2>/dev/null | sort -V)

          if [ -z "$FILES_LIST" ]; then
            echo "❌ 未检测到 files-* 目录"
            exit 1
          fi

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "检测到以下内核 files 目录："
          echo "$FILES_LIST"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          for FILES_DIR in $FILES_LIST; do
            echo "---------------------------------------------------"
            echo "写入补丁到：$FILES_DIR"

            RESET_DIR="${FILES_DIR}/include/dt-bindings/reset"
            CLOCK_DIR="${FILES_DIR}/include/dt-bindings/clock"

            mkdir -p "$RESET_DIR"
            mkdir -p "$CLOCK_DIR"

            wget -q -O "$RESET_DIR/mediatek,mt7987-resets.h" \
              "https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/b3f543825e91bdb5fb266c7d56f7f49b90fd7a54/target/linux/mediatek/files-6.6/include/dt-bindings/reset/mediatek%2Cmt7987-resets.h" || {
                echo "❌ reset 头文件下载失败"
                exit 1
              }

            wget -q -O "$CLOCK_DIR/mediatek,mt7987-clk.h" \
              "https://raw.githubusercontent.com/u-boot/u-boot/master/include/dt-bindings/clock/mediatek%2Cmt7987-clk.h" || {
                echo "❌ clock 头文件下载失败"
                exit 1
              }

            echo "✔ 已写入：$FILES_DIR"
          done

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✔ MTK 补丁同步写入完成"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ────────────────────────────────────────────────
      # 替换 luci-app-passwall
      # ────────────────────────────────────────────────
      - name: 替换 luci-app-passwall（稀疏检出最新版）
        working-directory: ./lede/feeds/luci/applications
        run: |
          rm -rf luci-app-passwall || true
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall.git temp-passwall
          cd temp-passwall
          git sparse-checkout init --cone
          git sparse-checkout set luci-app-passwall
          git checkout
          mv luci-app-passwall ../../
          cd ..
          rm -rf temp-passwall

      # ────────────────────────────────────────────────
      # LAN IP + Argon 主题
      # ────────────────────────────────────────────────
      - name: 应用自定义补丁（LAN IP + Argon 主题）
        working-directory: ./lede
        run: |
          export FULL_IP="${LAN_IP}"
          PREFIX_3=$(echo "$FULL_IP" | cut -d. -f1-3).
          PREFIX_2=$(echo "$FULL_IP" | cut -d. -f1-2).

          sed -i "s/192.168.1.1/$FULL_IP/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168.1./$PREFIX_3/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168./$PREFIX_2/g" package/base-files/files/bin/config_generate
          sed -i "s/192\.168\.1\.[0-9]\+/$FULL_IP/g" package/base-files/files/bin/config_generate

          # 强制 Argon 主题
          find feeds/luci/collections/ -type f -name Makefile -exec \
            sed -i -E 's/(luci-theme-)[a-zA-Z0-9_-]+/\1argon/g' {} \;

      # ────────────────────────────────────────────────
      # 缓存
      # ────────────────────────────────────────────────
      - name: 缓存下载文件
        uses: actions/cache@v4
        with:
          path: lede/dl
          key: ${{ runner.os }}-lede-dl-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-dl-

      - name: 缓存工具链
        uses: actions/cache@v4
        with:
          path: lede/staging_dir
          key: ${{ runner.os }}-lede-toolchain-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-toolchain-

      # ────────────────────────────────────────────────
      # 下载依赖包
      # ────────────────────────────────────────────────
      - name: 下载依赖包
        working-directory: ./lede
        run: |
          make download -j$(nproc) || make download -j1 V=s

      # ────────────────────────────────────────────────
      # 编译固件：MTK 支持 6.6/6.12/all
      # ────────────────────────────────────────────────
      - name: 编译固件（MTK支持 6.6/6.12/all）
        working-directory: ./lede
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "开始编译固件..."
          echo "IS_MTK=${IS_MTK}"
          echo "MTK_BUILD_MODE=${MTK_BUILD_MODE}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # 非 MTK 目标：正常编译一次即可
          if [ "${IS_MTK}" != "true" ]; then
            echo "⚠️ 非 MTK 目标，执行普通编译..."
            make -j$(nproc) V=s || make -j1 V=s
            mkdir -p ../output/firmware-default
            cp -rf bin/targets/* ../output/firmware-default/ || true
            exit 0
          fi

          # MTK 目标：按模式编译
          MAKEFILE="target/linux/mediatek/Makefile"
          if [ ! -f "$MAKEFILE" ]; then
            echo "❌ 未找到 $MAKEFILE"
            exit 1
          fi

          build_one() {
            KVER="$1"
            OUTDIR="$2"

            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "切换 mediatek 内核版本为 ${KVER}"
            echo "输出目录: ${OUTDIR}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

            sed -i "s/^KERNEL_PATCHVER:=.*/KERNEL_PATCHVER:=${KVER}/" "$MAKEFILE"
            grep "^KERNEL_PATCHVER" "$MAKEFILE" || true

            echo "清理编译缓存..."
            make clean

            echo "重新 defconfig..."
            make defconfig

            echo "开始编译..."
            make -j$(nproc) V=s || make -j1 V=s

            mkdir -p "../output/${OUTDIR}"
            cp -rf bin/targets/* "../output/${OUTDIR}/" || true

            echo "✔ 编译完成：${KVER}"
          }

          if [ "${MTK_BUILD_MODE}" = "6.6" ]; then
            build_one "6.6" "firmware-kernel-6.6"
          elif [ "${MTK_BUILD_MODE}" = "6.12" ]; then
            build_one "6.12" "firmware-kernel-6.12"
          else
            echo "✔ MTK_BUILD_MODE=all，将编译 6.6 + 6.12"
            build_one "6.6" "firmware-kernel-6.6"
            build_one "6.12" "firmware-kernel-6.12"
          fi

      # ────────────────────────────────────────────────
      # 打包插件 zip（固件原包保留）
      # ────────────────────────────────────────────────
      - name: 打包插件为 zip（保留固件包）
        run: |
          mkdir -p output/plugins_zip

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "开始打包插件为 zip..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          find output -type d -name "packages" | while read pkgdir; do
            base=$(echo "$pkgdir" | sed 's#output/##g' | tr '/' '_')
            zipname="plugins_${base}.zip"

            echo "打包: $pkgdir -> output/plugins_zip/$zipname"
            cd "$pkgdir"
            zip -r "../../../plugins_zip/$zipname" ./*
            cd - >/dev/null 2>&1
          done

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "插件 zip 打包完成："
          ls -la output/plugins_zip || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ────────────────────────────────────────────────
      # 生成 Release 说明 + Release Name（不会丢失固件目标来源）
      # ────────────────────────────────────────────────
      - name: 生成 Release 说明（目标来源不丢失）
        run: |
          DATE=$(date '+%y%m%d')
          NAME=$(echo "$SOURCE" | tr a-z A-Z)

          BOARD=$(grep -E "^CONFIG_TARGET_BOARD=" lede/.config | cut -d'"' -f2)
          SUBTARGET=$(grep -E "^CONFIG_TARGET_SUBTARGET=" lede/.config | cut -d'"' -f2)
          PROFILE=$(grep -E "^CONFIG_TARGET_PROFILE=" lede/.config | cut -d'"' -f2)

          [ -z "$BOARD" ] && BOARD="未知"
          [ -z "$SUBTARGET" ] && SUBTARGET="未知"

          TARGET="$BOARD/$SUBTARGET"
          [ -n "$PROFILE" ] && TARGET="$TARGET ($PROFILE)"

          if [ -n "$CONFIG_URL" ]; then
            CONFIG_SRC="$CONFIG_URL"
          else
            CONFIG_SRC="仓库/默认"
          fi

          if [ "$SOURCE" = "immortalwrt" ]; then
            SOURCE_URL="https://github.com/immortalwrt/immortalwrt"
          else
            SOURCE_URL="https://github.com/coolsnowwolf/lede"
          fi

          RELEASE_NAME="${NAME}-Thatdream-${DATE}"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

cat > release_note.txt << EOF
固件目标: $TARGET
编译时间: $(date '+%Y-%m-%d %H:%M:%S')
后台地址: http://${LAN_IP}
用户名: root
密码: password
备注：已预装 PassWall + MosDNS + Argon 主题
源代码来源: $SOURCE_URL
配置来源: $CONFIG_SRC
EOF

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Release Name: $RELEASE_NAME"
          echo "Release Note:"
          cat release_note.txt
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      # ────────────────────────────────────────────────
      # 上传 Artifact
      # ────────────────────────────────────────────────
      - name: 上传构建产物 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.run_number }}
          path: output/**/*
          retention-days: 14

      # ────────────────────────────────────────────────
      # 发布到 GitHub Releases
      # ────────────────────────────────────────────────
      - name: 发布到 GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release_note.txt
          files: |
            output/**/*
          draft: false
          prerelease: false
