name: 构建 LEDE 固件 (带自定义 .config)

on:
  workflow_dispatch:
    inputs:
      lan_ip:
        description: '自定义后台 LAN IP（例如 192.168.5.1 或 10.0.0.1）'
        required: false
        default: '10.0.0.1'
      ssh:
        description: '启用 SSH 连接到 Actions（调试用）'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 3 * * *'   # UTC 3:00 ≈ 北京时间 11:00
  push:
    branches:
      - main

env:
  LAN_IP: ${{ github.event.inputs.lan_ip || '10.0.0.1' }}
  # 本地 .config 文件路径（相对于仓库根目录）
  # 推荐选项：
  #   - 'X86/.config'          ← 如果你放在 X86 子目录
  #   - '.config'              ← 如果直接放根目录
  #   - 'config/040.config'    ← 参考你提供的例子
  CONFIG_FILE: '.config'
  
  # 如果本地没有，可选的远程 raw 链接（公开可访问）
  REMOTE_CONFIG_URL: "https://github.com/xiaojing110/openwrt-TD/edit/main/.config"   # 留空则不尝试远程下载；或填 https://raw.githubusercontent.com/你的用户名/仓库/分支/X86/.config

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip \
            p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: 克隆 LEDE 源码
        run: |
          git clone https://github.com/coolsnowwolf/lede.git lede
          cd lede

      - name: 修改 feeds.conf.default
        working-directory: ./lede
        run: |
          sed -i '/^src-git luci/c\src-git luci https://github.com/coolsnowwolf/luci.git;openwrt-25.12' feeds.conf.default
          sed -i 's/^#src-git qmodem/src-git qmodem/' feeds.conf.default || true
          echo "src-git mosdns https://github.com/sbwml/luci-app-mosdns.git" >> feeds.conf.default

      - name: 更新并安装 feeds
        working-directory: ./lede
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ────────────────────────────────────────────────
      # 加载自定义 .config（参考你提供的代码风格）
      # ────────────────────────────────────────────────
      - name: 加载自定义 .config 文件
        working-directory: ./lede
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "尝试加载 .config 文件"
          echo "优先使用本地文件：${{ env.CONFIG_FILE }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          CONFIG_PLACED=false
          CONFIG_SOURCE="未找到"

          # 优先：从仓库复制本地 .config
          if [ -f "../../${{ env.CONFIG_FILE }}" ]; then
            echo "✓ 找到本地文件：${{ env.CONFIG_FILE }}"
            cp -f "../../${{ env.CONFIG_FILE }}" ./.config
            CONFIG_PLACED=true
            CONFIG_SOURCE="本地 ${{ env.CONFIG_FILE }}"
          else
            echo "本地文件 ${{ env.CONFIG_FILE }} 不存在"
          fi

          # 如果本地没有 → 尝试远程下载
          if [ "$CONFIG_PLACED" = false ] && [ -n "${{ env.REMOTE_CONFIG_URL }}" ]; then
            echo "本地未找到，开始从远程下载..."
            echo "URL: ${{ env.REMOTE_CONFIG_URL }}"
            wget --no-check-certificate -t 3 -T 15 -O ./.config "${{ env.REMOTE_CONFIG_URL }}" || {
              echo "× 下载失败"
            }
            if [ -s ./.config ] && grep -q "^CONFIG_" ./.config; then
              echo "✓ 远程下载成功"
              CONFIG_PLACED=true
              CONFIG_SOURCE="远程 ${{ env.REMOTE_CONFIG_URL }}"
            else
              echo "× 远程文件无效或下载失败"
              rm -f ./.config
            fi
          fi

          # 最终判断
          if [ "$CONFIG_PLACED" = true ]; then
            echo "成功加载 .config！来源：$CONFIG_SOURCE"
            echo "大小：$(stat -c %s ./.config) 字节"
            echo "关键配置预览："
            grep -E "CONFIG_TARGET_|CONFIG_PACKAGE_luci|passwall|mosdns|argon" ./.config || echo "(无匹配)"
          else
            echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
            echo "  警告：未找到任何 .config 文件！"
            echo "  将使用默认配置编译（可能缺少插件）"
            echo "  请检查："
            echo "    - 仓库中是否有 ${{ env.CONFIG_FILE }}？"
            echo "    - REMOTE_CONFIG_URL 是否正确设置？"
            echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
            # 如需强制要求 .config，可打开下面一行：
            # exit 1
          fi

      - name: 执行 defconfig
        working-directory: ./lede
        run: |
          make defconfig
          echo "defconfig 后关键配置："
          grep -E "TARGET_|luci|passwall|mosdns|argon|xray" .config || echo "(无匹配项)"

      - name: 替换 luci-app-passwall（使用最新版）
        working-directory: ./lede/feeds/luci/applications
        run: |
          rm -rf luci-app-passwall || true
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall.git temp
          cd temp
          git sparse-checkout init --cone
          git sparse-checkout set luci-app-passwall
          git checkout
          mv luci-app-passwall ../../
          cd ..
          rm -rf temp

      - name: 应用自定义补丁（LAN IP + 主题）
        working-directory: ./lede
        run: |
          FULL_IP="${{ env.LAN_IP }}"
          PREFIX_3=$(echo "$FULL_IP" | cut -d. -f1-3).
          PREFIX_2=$(echo "$FULL_IP" | cut -d. -f1-2).
          sed -i "s/192.168.1.1/$FULL_IP/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168.1./$PREFIX_3/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168./$PREFIX_2/g" package/base-files/files/bin/config_generate
          sed -i "s/192\.168\.1\.[0-9]\+/$FULL_IP/g" package/base-files/files/bin/config_generate

          # 强制 Argon 主题
          find feeds/luci/collections/ -type f -name Makefile -exec \
            sed -i -E 's/(luci-theme-)[a-zA-Z0-9_-]+/\1argon/g' {} \;

      - name: 缓存 dl 和 staging_dir
        uses: actions/cache@v4
        with:
          path: |
            lede/dl
            lede/staging_dir
          key: ${{ runner.os }}-lede-build-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-build-

      - name: 下载依赖包
        working-directory: ./lede
        run: make download -j$(nproc) || make download -j1 V=s

      - name: 编译固件
        working-directory: ./lede
        run: |
          make -j$(nproc) V=s || make -j1 V=s

      - name: 生成说明文件
        working-directory: ./lede
        run: |
          mkdir -p bin/targets/x86/64
          cat > bin/targets/x86/64/固件说明.txt << EOF
          ==================== LEDE 固件信息 ====================
          目标: x86_64 generic
          编译时间: $(date '+%Y-%m-%d %H:%M:%S %Z')
          后台: http://${{ env.LAN_IP }}
          用户: root / password
          .config 来源: ${{ env.CONFIG_FILE }} 或远程
          备注: PassWall + MosDNS + Argon 主题
          EOF

      - name: 上传 artifact
        uses: actions/upload-artifact@v4
        with:
          name: lede-x86_64-run${{ github.run_number }}
          path: lede/bin/targets/x86/64/*
          retention-days: 14

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: LEDE x86_64 - ${{ env.LAN_IP }} - ${{ github.run_number }}
          body_path: lede/bin/targets/x86/64/固件说明.txt
          files: lede/bin/targets/x86/64/*
          draft: false
          prerelease: false

      # 可选：调试用 SSH（参考你提供的代码）
      - name: SSH 连接（调试）
        if: ${{ github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh') }}
        uses: csexton/debugger-action@master
