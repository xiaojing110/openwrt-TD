name: 构建 LEDE 固件

on:
  workflow_dispatch:
    inputs:
      source:
        description: '选择编译源码（lede 或 immortalwrt）'
        required: true
        default: 'lede'
        type: choice
        options:
          - lede
          - immortalwrt

      lan_ip:
        description: '自定义后台 LAN IP（例如 192.168.5.1 或 10.0.0.1）'
        required: false
        default: '10.0.0.1'

      config_url:
        description: '自定义 .config 地址（填写则优先使用此配置文件）'
        required: false
        default: ''

  schedule:
    - cron: '0 3 * * *'   # UTC 3:00 ≈ 北京时间 11:00

  push:
    branches:
      - main

env:
  LAN_IP: ${{ github.event.inputs.lan_ip || '10.0.0.1' }}
  SOURCE: ${{ github.event.inputs.source || 'lede' }}

  # 用户自定义 config 地址（如果填了就优先用它）
  CUSTOM_CONFIG_URL: ${{ github.event.inputs.config_url || '' }}

  # 默认 raw 下载备用 config
  REMOTE_CONFIG_URL: "https://raw.githubusercontent.com/xiaojing110/openwrt-TD/main/X86/.config"

  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: 检出仓库代码（强制 main）
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: 显示仓库文件结构（调试必备）
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "当前目录："
          pwd
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "根目录文件："
          ls -la
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "X86 目录文件："
          ls -la X86 || echo "⚠️ X86 文件夹不存在"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "查找 config 文件："
          find . -maxdepth 3 -type f \( -name ".config" -o -name "*.config" \) || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Git 状态："
          git status || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "当前分支："
          git branch -a || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "当前 commit："
          git log -1 --oneline || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 设置时区
        run: |
          sudo timedatectl set-timezone "${TZ}"

      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip \
            p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: 最大化构建空间
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      # ────────────────────────────────────────────────
      # 选择源码：LEDE 或 ImmortalWrt
      # ────────────────────────────────────────────────
      - name: 克隆 OpenWrt 源码（支持 lede / immortalwrt）
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "选择的源码：${{ env.SOURCE }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ "${{ env.SOURCE }}" = "lede" ]; then
            echo "开始克隆 LEDE 源码..."
            git clone https://github.com/coolsnowwolf/lede.git lede
          elif [ "${{ env.SOURCE }}" = "immortalwrt" ]; then
            echo "开始克隆 ImmortalWrt 源码..."
            git clone https://github.com/immortalwrt/immortalwrt.git lede
          else
            echo "❌ 无效 SOURCE 参数: ${{ env.SOURCE }}"
            exit 1
          fi

      # ────────────────────────────────────────────────
      # 执行 diy.sh（必须在 feeds update/install 之前）
      # ────────────────────────────────────────────────
      - name: 执行 diy.sh（更新 feeds 之前执行）
        working-directory: ./lede
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "检查仓库根目录是否存在 diy.sh ..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ -f "../diy.sh" ]; then
            echo "✔ 找到 diy.sh，开始执行..."
            chmod +x ../diy.sh
            bash ../diy.sh
            echo "✔ diy.sh 执行完成"
          else
            echo "⚠️ 未找到 diy.sh，跳过"
          fi

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "feeds.conf.default 当前内容："
          cat feeds.conf.default || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 修改 feeds.conf.default（原有自定义）
        working-directory: ./lede
        run: |
          sed -i '/^src-git luci/c\src-git luci https://github.com/coolsnowwolf/luci.git;openwrt-25.12' feeds.conf.default
          sed -i 's/^#src-git qmodem/src-git qmodem/' feeds.conf.default || true
          echo "src-git mosdns https://github.com/sbwml/luci-app-mosdns.git" >> feeds.conf.default

      - name: 更新并安装 feeds（重要：放在 .config 之前）
        working-directory: ./lede
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a -f

      # ────────────────────────────────────────────────
      # 优先使用用户输入 config_url，否则用仓库配置，否则用默认 raw
      # ────────────────────────────────────────────────
      - name: 加载 .config（支持自定义 config_url 优先）
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "开始加载配置文件 .config..."
          echo "自定义 config_url: ${{ env.CUSTOM_CONFIG_URL }}"
          echo "默认 raw URL:      ${{ env.REMOTE_CONFIG_URL }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # 1) 如果用户输入了 config_url，直接优先使用
          if [ -n "${{ env.CUSTOM_CONFIG_URL }}" ]; then
            echo "✔ 检测到用户自定义 config_url，优先下载..."
            wget -O lede/.config "${{ env.CUSTOM_CONFIG_URL }}" || {
              echo "❌ 自定义 config_url 下载失败，请检查地址是否正确"
              exit 1
            }

            if [ ! -s "lede/.config" ]; then
              echo "❌ 下载成功但文件为空，停止运行"
              exit 1
            fi

            echo "✔ 自定义 config_url 下载成功"

          else
            echo "⚠️ 未填写 config_url，开始查找仓库中的 .config 文件..."
            echo "优先级："
            echo "  1) ./.config"
            echo "  2) ./X86/.config"
            echo "  3) ./X86/X86.config"
            echo "找不到则使用默认 raw 下载"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

            FOUND_CONFIG=""

            if [ -f ".config" ]; then
              FOUND_CONFIG=".config"
            elif [ -f "X86/.config" ]; then
              FOUND_CONFIG="X86/.config"
            elif [ -f "X86/X86.config" ]; then
              FOUND_CONFIG="X86/X86.config"
            fi

            if [ -n "$FOUND_CONFIG" ]; then
              echo "✔ 已找到仓库配置文件：$FOUND_CONFIG"
              cp -fv "$FOUND_CONFIG" lede/.config
            else
              echo "⚠️ 仓库内未找到任何 .config，准备使用默认 raw 下载..."

              wget -O lede/.config "${{ env.REMOTE_CONFIG_URL }}" || {
                echo "❌ raw 下载失败，请检查 URL 是否正确"
                exit 1
              }

              if [ ! -s "lede/.config" ]; then
                echo "❌ 下载成功但文件为空，停止运行"
                exit 1
              fi

              echo "✔ 默认 raw 下载成功"
            fi
          fi

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "最终 lede/.config 文件信息："
          ls -la lede/.config
          echo "前 20 行预览："
          head -n 20 lede/.config || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 执行 defconfig 并显示摘要
        working-directory: ./lede
        run: |
          make defconfig
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "最终 .config 关键配置预览："
          grep -E "CONFIG_TARGET_|CONFIG_PACKAGE_luci|CONFIG_PACKAGE_passwall|CONFIG_PACKAGE_mosdns|CONFIG_PACKAGE_luci-theme-argon" .config | sort | uniq || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: 替换 luci-app-passwall（稀疏检出最新版）
        working-directory: ./lede/feeds/luci/applications
        run: |
          rm -rf luci-app-passwall || true
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall.git temp-passwall
          cd temp-passwall
          git sparse-checkout init --cone
          git sparse-checkout set luci-app-passwall
          git checkout
          mv luci-app-passwall ../../
          cd ..
          rm -rf temp-passwall

      - name: 应用自定义补丁（LAN IP + Argon 主题）
        working-directory: ./lede
        run: |
          export FULL_IP="${{ env.LAN_IP }}"
          PREFIX_3=$(echo "$FULL_IP" | cut -d. -f1-3).
          PREFIX_2=$(echo "$FULL_IP" | cut -d. -f1-2).

          sed -i "s/192.168.1.1/$FULL_IP/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168.1./$PREFIX_3/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168./$PREFIX_2/g" package/base-files/files/bin/config_generate
          sed -i "s/192\.168\.1\.[0-9]\+/$FULL_IP/g" package/base-files/files/bin/config_generate

          # 强制使用 Argon 主题
          find feeds/luci/collections/ -type f -name Makefile -exec \
            sed -i -E 's/(luci-theme-)[a-zA-Z0-9_-]+/\1argon/g' {} \;

      - name: 缓存下载文件
        uses: actions/cache@v4
        with:
          path: lede/dl
          key: ${{ runner.os }}-lede-dl-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-dl-

      - name: 缓存工具链
        uses: actions/cache@v4
        with:
          path: lede/staging_dir
          key: ${{ runner.os }}-lede-toolchain-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-toolchain-

      - name: 下载依赖包
        working-directory: ./lede
        run: |
          make download -j$(nproc) || make download -j1 V=s

      - name: 编译固件
        working-directory: ./lede
        run: |
          make -j$(nproc) V=s || make -j1 V=s

      - name: 生成固件说明文件
        working-directory: ./lede
        run: |
          mkdir -p bin/targets/x86/64
          cat > bin/targets/x86/64/固件说明.txt << EOF
          ==================== OpenWrt 固件信息 ====================
          源码来源: ${{ env.SOURCE }}
          编译时间: $(date '+%Y-%m-%d %H:%M:%S')
          后台地址: http://${{ env.LAN_IP }}
          用户名: root
          密码: password
          备注：已预装 PassWall + MosDNS + Argon 主题
          配置来源：优先 config_url -> 仓库 config -> 默认 raw
          config_url: ${{ env.CUSTOM_CONFIG_URL }}
          默认 raw URL: ${{ env.REMOTE_CONFIG_URL }}
          EOF

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-x86_64-${{ env.SOURCE }}-${{ github.run_number }}
          path: lede/bin/targets/x86/64/*
          retention-days: 14

      - name: 发布到 GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ env.SOURCE }}-${{ github.run_number }}
          name: OpenWrt x86_64 (${{ env.SOURCE }}) - ${{ env.LAN_IP }} - ${{ github.run_number }}
          body_path: lede/bin/targets/x86/64/固件说明.txt
          files: |
            lede/bin/targets/x86/64/*
          draft: false
          prerelease: false
