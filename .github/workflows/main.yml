name: Build LEDE Firmware

on:
  workflow_dispatch:
    inputs:
      lan_ip:
        description: '自定义后台 LAN IP（例如 10.0.0.1）'
        required: false
        default: '10.0.0.1'
  #schedule:
   # - cron: '0 3 * * *' # UTC 3:00 ≈ 北京时间 11:00
  push:
    branches:
      - main

# 环境变量：优先使用手动输入的 IP，否则默认 10.0.0.1
env:
  LAN_IP: ${{ github.event.inputs.lan_ip || '10.0.0.1' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # 必须，用于发布 Releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 安装 OpenWrt/LEDE 编译所需系统依赖
      - name: Install build dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip \
            p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs \
            upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt clean
          sudo rm -rf /var/lib/apt/lists/*

      # 最大化构建空间
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      # 克隆 LEDE 源码
      - name: Clone LEDE source
        run: |
          git clone https://github.com/coolsnowwolf/lede.git
          cd lede

      # 修改 feeds.conf.default（luci 分支、qmodem、mosdns 等）
      - name: Modify feeds.conf.default
        working-directory: ./lede
        run: |
          sed -i '/^src-git luci/c\src-git luci https://github.com/coolsnowwolf/luci.git;openwrt-25.12' feeds.conf.default
          sed -i 's/^#src-git qmodem/src-git qmodem/' feeds.conf.default
          echo "src-git mosdns https://github.com/sbwml/luci-app-mosdns.git" >> feeds.conf.default
          cat feeds.conf.default

      # 更新并安装 feeds
      - name: Update and install feeds
        working-directory: ./lede
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 特殊替换 luci-app-passwall（稀疏检出）
      - name: Replace luci-app-passwall with sparse checkout
        working-directory: ./lede/feeds/luci/applications
        run: |
          rm -rf luci-app-passwall || true
          git clone --depth=1 https://github.com/Openwrt-Passwall/openwrt-passwall.git temp-passwall
          cd temp-passwall
          git sparse-checkout init --cone
          git sparse-checkout set luci-app-passwall
          git checkout
          mv luci-app-passwall ../../
          cd ..
          rm -rf temp-passwall
          echo "luci-app-passwall 替换完成"

      # 修复 grub2 编译错误（禁用 arm-efi 变体）
      - name: Disable grub2 arm-efi variant
        working-directory: ./lede
        run: |
          echo "修复 grub2 arm-efi 导致的 invalid ELF header 错误..."
          sed -i '/arm-efi/d' package/boot/grub2/Makefile || true
          sed -i 's/GRUB2_EFI_IMAGES.*arm-efi.*$/GRUB2_EFI_IMAGES := x86_64-efi/' package/boot/grub2/Makefile || true

      # 应用自定义补丁（动态 IP + 主题）
      - name: Apply custom patches
        working-directory: ./lede
        run: |
          echo "修改默认 IP 为 ${{ env.LAN_IP }}..."
          sed -i "s/192.168.1.1/${LAN_IP}/g" package/base-files/files/bin/config_generate
          sed -i "s/192.168.1./${LAN_IP%.*}./g" package/base-files/files/bin/config_generate
          sed -i "s/192.168./${LAN_IP%.*.*}./g" package/base-files/files/bin/config_generate
          
          echo "设置主题为 luci-theme-argon..."
          find feeds/luci/collections/ -type f -name Makefile -exec \
            sed -i -E 's/(luci-theme-)[a-zA-Z0-9_-]+/\1argon/g' {} \;

      # 缓存下载文件
      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: lede/dl
          key: ${{ runner.os }}-lede-downloads-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-downloads-

      # 缓存工具链
      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: lede/staging_dir
          key: ${{ runner.os }}-lede-toolchain-${{ hashFiles('lede/.config') }}
          restore-keys: ${{ runner.os }}-lede-toolchain-

      # 准备 .config（优先本地文件，否则自动生成）
      - name: Prepare .config
        working-directory: ./lede
        run: |
          echo "=================== 开始准备 .config ==================="
          
          # 优先级1：仓库根目录 .config（推荐）
          if [ -f ../.config ]; then
            echo "✓ 使用仓库根目录下的 .config（最高优先级）"
            cp ../.config ./.config
          
          # 优先级2：X86/ 子目录下的 .config
          elif [ -f ../X86/.config ]; then
            echo "✓ 使用 ../X86/.config"
            cp ../X86/.config ./.config
          
          # 优先级3：自动生成默认配置
          else
            echo "⚠️ 未找到本地 .config，使用内置自动配置（IP 将在补丁中动态设置为 ${{ env.LAN_IP }}）"
            cat > .config << 'EOF'
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-theme-argon=y
          
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-mosdns=y
          
          CONFIG_PACKAGE_firewall4=y
          CONFIG_PACKAGE_nftables=y
          CONFIG_PACKAGE_kmod-nft-core=y
          
          CONFIG_CLEAN_IPKG=y
          CONFIG_BUILDBOT=y
          
          # 可选插件（按需取消注释）
          # CONFIG_PACKAGE_luci-app-qmodem=y
          # CONFIG_PACKAGE_xray-core=y
          # CONFIG_PACKAGE_v2fly-geoip=y
          # CONFIG_PACKAGE_v2fly-geosite=y
          EOF
          echo "已生成内置默认 .config"
          fi
          
          echo "执行 make defconfig ..."
          make defconfig
          
          echo "=================== 当前 .config 关键项检查 ==================="
          grep -E "TARGET_x86|luci|passwall|mosdns|argon|firewall4|qmodem|xray|v2fly" .config || echo "（未匹配到关键词）"
          echo "================================================================="

      # 下载依赖包
      - name: Download dependencies
        working-directory: ./lede
        run: |
          make download -j$(nproc) || make download -j1 V=s

      # 编译固件
      - name: Build firmware
        working-directory: ./lede
        run: |
          make -j$(nproc) V=s || make -j1 V=s

      # 生成固件说明文件（包含所有关键信息）
      - name: Generate firmware info
        working-directory: ./lede
        run: |
          echo "生成固件说明文件（固件名字、编译时间、后台IP、账户密码等）..."
          mkdir -p bin/targets/x86/64
          cat > bin/targets/x86/64/固件说明.txt << EOF
          ==================== LEDE 固件信息 ====================
          
          固件名称: LEDE x86_64 Generic (coolsnowwolf/lede)
          编译时间: $(date '+%Y-%m-%d %H:%M:%S UTC')
          后台访问地址: http://${{ env.LAN_IP }}
          默认用户名: root
          默认密码: 无（首次登录后在 LuCI 设置密码）
          
          构建来源: ${{ github.repository }} (${{ github.ref_name }})
          构建编号: ${{ github.run_number }}
          构建触发方式: ${{ github.event_name }}
          
          ====================================================
          提示：
          1. 首次登录请直接访问 http://${{ env.LAN_IP }}，设置密码
          2. PassWall / MosDNS 等插件已预装
          3. 如需更多插件，可在 LuCI 中安装
          EOF
          echo "固件说明文件生成完成"

      # 清理临时文件
      - name: Clean temporary files
        run: |
          rm -rf lede/tmp/* || true

      # 整理并上传到 Artifacts（供下载）
      - name: Organize and upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LEDE-firmware-x86_64-${{ github.run_number }}
          path: |
            lede/bin/targets/x86/64/*
          retention-days: 14

      # 发布到 GitHub Releases
      - name: Release to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: lede-${{ github.run_number }}
          name: LEDE x86_64 ${{ format('{0,date,yyyy-MM-dd}') }} Build #${{ github.run_number }}
          body: |
            **自动编译的 LEDE 固件**
            
            - **后台 IP**：`${{ env.LAN_IP }}`
            - **用户名**：`root`
            - **密码**：首次登录设置（无默认密码）
            - **编译时间**：`$(date '+%Y-%m-%d %H:%M:%S')`
            
            完整信息请查看附件中的 **固件说明.txt**
          files: |
            lede/bin/targets/x86/64/*
          draft: false
          prerelease: false
